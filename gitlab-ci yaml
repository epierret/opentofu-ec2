
stages:
  - validate
  - plan
  - apply
  - deploy

variables:
  TF_IN_AUTOMATION: "true"
  TF_WORKSPACE: "default"

before_script:
  - apk add --no-cache curl unzip git bash
  - curl -L https://github.com/opentofu/opentofu/releases/download/v0.2.0/opentofu_0.2.0_linux_amd64.zip -o opentofu.zip
  - unzip opentofu.zip
  - mv opentofu /usr/local/bin/
  - opentofu version
  - git config --global user.email "pierretenrique@gitlab.com"
  - git config --global user.name "Enrique Pierret"

validate:
  stage: validate
  script:
    - opentofu fmt -check
    - opentofu validate

plan:
  stage: plan
  script:
    - opentofu init
    - opentofu plan -var-file=terraform.tfvars -out=tfplan
  artifacts:
    paths:
      - tfplan
    expire_in: 1 hour

apply:
  stage: apply
  script:
    - opentofu init
    - opentofu apply -auto-approve tfplan
  when: manual

deploy:
 stage: deploy
  
