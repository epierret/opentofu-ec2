stages:
  - validate
    - plan
      - apply

      variables:
        TF_IN_AUTOMATION: "true"
          TF_WORKSPACE: "default"

          before_script:
            # Install OpenTofu (or Terraform) CLI
              - apk add --no-cache curl unzip git bash
                - curl -L https://github.com/opentofu/opentofu/releases/download/v0.2.0/opentofu_0.2.0_linux_amd64.zip -o opentofu.zip
                  - unzip opentofu.zip
                    - mv opentofu /usr/local/bin/
                      - opentofu version

                      validate:
                        stage: validate
                          script:
                              - opentofu fmt -check
                                  - opentofu validate

                                  plan:
                                    stage: plan
                                      script:
                                          - opentofu init
                                              - opentofu plan -var-file=terraform.tfvars -out=tfplan
                                                artifacts:
                                                    paths:
                                                          - tfplan
                                                              expire_in: 1 hour

                                                              apply:
                                                                stage: apply
                                                                  script:
                                                                      - opentofu init
                                                                          - opentofu apply -auto-approve tfplan
                                                                            when: manual  # Manual approval to apply in prod